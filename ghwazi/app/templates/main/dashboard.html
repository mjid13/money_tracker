{% extends "main/base.html" %}

{% block title %}{{ _('Dashboard') }} - Money Tracker{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-12">
        <div class="welcome-section p-4 rounded-4 bg-primary bg-opacity-10 position-relative overflow-hidden">
            <div class="position-absolute top-0 end-0 p-3">
                <div class="dropdown">
                    <button class="btn btn-link text-decoration-none" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('main.profile') }}"><i class="bi bi-person me-2"></i>{{ _('Profile') }}</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('email.email_configs') }}"><i class="bi bi-gear me-2"></i>{{ _('Settings') }}</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>{{ _('Logout') }}</a></li>
                    </ul>
                </div>
            </div>
            <h1 class="display-5 fw-bold mb-3">{{ _('Welcome back, %(username)s! ðŸ‘‹', username=session.username) }}</h1>
            <p class="lead mb-4">{{ _('Track your finances and your transactions all in one place.') }}</p>
            <div class="d-flex flex-wrap gap-2 ">
                <a href="{{ url_for('account.add_account') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>{{ _('Add Bank Account') }}
                </a>
                <a href="{{ url_for('account.accounts') }}" class="btn btn-outline-primary">
                    <i class="bi bi-bank me-2"></i>{{ _('View All Accounts') }}
                </a>
                <a href="{{ url_for('category.categories') }}" class="btn btn-outline-primary">
                    <i class="bi bi-tags me-2"></i>{{ _('Categories') }}
                </a>
                <a href="{{ url_for('main.counterparties') }}" class="btn btn-outline-primary">
                    <i class="bi bi-people me-2"></i>{{ _('Counterparties') }}
                </a>
                <form method="post" action="{{ url_for('category.auto_categorize') }}" style="display:inline;" class="auto-categorize-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-warning auto-categorize-btn">
                        <i class="bi bi-magic me-2"></i>{{ _('Auto-Categorize') }}
                    </button>
                </form>
                <form method="post" action="{{ url_for('oauth.sync_gmail') }}" style="display:inline;" class="sync-gmail-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-warning">
                        <i class="bi bi-arrow-repeat me-2"></i>{{ _('Sync Gmail') }}
                    </button>
                </form>

            </div>
        </div>
    </div>
    <div class="col-md-12">
        <div class="card h-100">
            <div class="card-header bg-transparent border-bottom-0 d-flex justify-content-between align-items-center">
                <h3 class="h4 mb-0">{{ _('Your Bank Accounts') }}</h3>
                <a href="{{ url_for('account.add_account') }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus"></i> {{ _('Add') }}
                </a>
            </div>
            <div class="card-body">
                {% if accounts %}
                <div class="account-list">
                    {% for account in accounts %}
                    <a href="{{ url_for('account.account_details', account_number=account.account_number) }}"
                       class="account-item d-block text-decoration-none mb-1 p-3 rounded-3 border {% if loop.last %}mb-0{% endif %}"
                       data-account-number="{{ account.account_number }}"
                       style="transition: all 0.2s ease;">
                        <div class="d-flex justify-content-between align-items-start{% if text_direction == 'rtl' %} flex-row-reverse{% endif %}">                            <div>
                                <h5 class="mb-1 d-flex align-items-center">
                                    <i class="bi bi-bank2 me-2"></i>
                                    {{ account.account_number|account_number_rtl }}
                                    {% if account.account_number in scraping_account_numbers %}
                                    <span class="badge bg-warning text-dark ms-2">
                                        <i class="bi bi-arrow-repeat me-1 spin"></i>{{ _('Scraping') }}
                                    </span>
                                    {% endif %}
                                    <span class="badge bg-info-subtle text-info ms-2 d-none account-sync-badge" data-account-number="{{ account.account_number }}">
                                        <i class="bi bi-arrow-repeat me-1 spin"></i>{{ _('Syncing') }}
                                    </span>
                                </h5>
                                <p class="mb-1 text-body-secondary">{{ _('Holder') }}: {{ account.account_holder }}</p>
                                <small class="text-body-secondary">{{ account.bank_name }}</small>
                            </div>
                            <span class="badge bg-primary bg-opacity-10 text-primary p-3 rounded-3">
                                {{ account.currency }} {{ "{:,.3f}".format(account.balance) }}
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-bank2 display-4 text-muted"></i>
                    <p class="mt-3 mb-4">{{ _("You don't have any bank accounts yet.") }}</p>
                    <a href="{{ url_for('account.add_account') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>{{ _('Add Your First Account') }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% if accounts %}
    
    <!-- Budget Summary Cards -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-primary mb-0">
                <i class="bi bi-wallet2 me-2"></i>{{ _('Budget Overview') }}
            </h4>
            <div class="d-flex gap-2">
                <a href="{{ url_for('budget.dashboard') }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-bar-chart me-2"></i>{{ _('View All') }}
                </a>
                <a href="{{ url_for('budget.setup') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus-circle me-2"></i>{{ _('Create Budget') }}
                </a>
            </div>
        </div>
        
        {% if budgets and budgets|length > 0 %}
        <div class="budget-overview-grid mb-4">
            <div class="row g-3">
                {% for b in budgets[:6] %}
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <div class="budget-card {% if b.alerts.gte_100 %}budget-danger{% elif b.alerts.custom_exceeded %}budget-warning{% else %}budget-success{% endif %}">
                        <div class="budget-card-header">
                            <div class="budget-icon">
                                <i class="bi bi-tag-fill"></i>
                            </div>
                            <div class="budget-status">{{ '%.0f' % b.percent_used }}%</div>
                        </div>
                        <h6 class="budget-name">{{ b.category_name }}</h6>
                        <div class="budget-amounts">
                            <div class="spent">OMR {{ '%.0f' % b.spent }}</div>
                            <div class="total">/ {{ '%.0f' % b.amount }}</div>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar" style="width: {% if b.percent_used > 100 %}100{% else %}{{ b.percent_used }}{% endif %}%"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if budgets|length > 6 %}
                <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                    <a href="{{ url_for('budget.dashboard') }}" class="budget-card budget-more">
                        <div class="budget-more-content">
                            <div class="budget-more-icon">
                                <i class="bi bi-plus-circle"></i>
                            </div>
                            <div class="budget-more-text">
                                <strong>+{{ budgets|length - 6 }}</strong>
                                <small>{{ _('More') }}</small>
                            </div>
                        </div>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="budget-empty-state mb-4">
            <div class="text-center p-4 border rounded-3 bg-light bg-opacity-50">
                <i class="bi bi-wallet2 display-6 text-muted mb-3"></i>
                <h6 class="text-muted mb-2">{{ _('No budgets yet') }}</h6>
                <p class="text-muted small mb-3">{{ _('Start tracking your spending by creating budgets') }}</p>
                <a href="{{ url_for('budget.setup') }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle me-2"></i>{{ _('Create First Budget') }}
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Charts Section -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-primary mb-0">
                <i class="bi bi-graph-up me-2"></i>{{ _('Financial Analytics') }}
            </h4>
        </div>
    <div class="col-12">
        <!-- Account Selection for Charts -->
        <div class="card mb-4 filters-card">
            <div class="card-body py-3">
                <div class="d-flex flex-wrap align-items-center gap-2">
                    <span class="badge bg-primary-subtle text-primary p-2 rounded-3 d-flex align-items-center">
                        <i class="bi bi-funnel-fill me-1"></i>
                        {{ _('Filters') }}
                    </span>
                    <div class="me-auto d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary d-inline d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#dashboardFilters" aria-expanded="true" aria-controls="dashboardFilters">
                            <i class="bi bi-sliders"></i>
                            {{ _('Show/Hide') }}
                        </button>
                        <button class="btn btn-sm btn-link text-danger" id="clearChartFilters" type="button">
<!--                            <i class="bi bi-x-circle"></i>-->
                            {{ _('Clear') }}
                        </button>
                    </div>
                </div>
                <div id="dashboardFilters" class="collapse show d-md-block mt-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-12">
                            <div class="quick-range d-flex flex-wrap gap-2 overflow-auto pt-1 mb-2" aria-label="Account filter">
                                <button type="button" class="btn btn-sm btn-primary quick-account-btn active" data-account="all">{{ _('All Accounts') }}</button>
                                {% for account in accounts %}
                                <button type="button" class="btn btn-sm btn-outline-primary quick-account-btn" data-account="{{ account.account_number }}">{{ account.bank_name }} ({{ account.account_number|account_number_rtl }})</button>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="quick-range d-flex flex-wrap gap-2 overflow-auto pt-1" aria-label="Date range filter">
                                <button type="button" class="btn btn-sm btn-primary quick-range-btn active" data-range="overall">{{ _('Overall') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-primary quick-range-btn" data-range="2w">{{ _('2 Weeks') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-primary quick-range-btn" data-range="1m">{{ _('1 Month') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-primary quick-range-btn" data-range="3m">{{ _('3 Months') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-primary quick-range-btn" data-range="6m">{{ _('6 Months') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-primary quick-range-btn" data-range="12m">{{ _('12 Months') }}</button>
                                <button type="button" class="btn btn-sm btn-outline-primary quick-range-btn" data-range="24m">{{ _('24 Months') }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Monthly Trend Chart -->
            <div class="col-md-6 col-lg-6">
                <div class="card h-100 chart-card ">
                    <div class="card-body">
                        <h5 class="chart-title">
                            <i class="bi bi-graph-up-arrow"></i>
                            {{ _('Monthly Trends') }}
                        </h5>
                        <p class="chart-description">{{ _('Track your financial patterns with income and expense trends over time') }}</p>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Category Distribution Chart -->
            <div class="col-md-6 col-lg-6">
                <div class="card h-100 chart-card">
                    <div class="card-header bg-transparent border-bottom-0 d-flex justify-content-between align-items-center py-3{% if text_direction == 'rtl' %} flex-row-reverse{% endif %}">
                        <h5 class="chart-title mb-0">
                            <i class="bi bi-pie-chart-fill"></i>
                            {{ _('Category Distribution') }}
                        </h5>
                        <!-- Toggle will be inserted here by JavaScript -->
                        <div id="category-toggle-container" class="category-header-toggle"></div>
                    </div>
                    <div class="card-body pt-2">
                        <p class="chart-description mb-3">{{ _('Visualize your spending patterns with interactive category breakdown') }}</p>
                        {% if categories %}
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-tags display-4 text-muted"></i>
                            <p class="mt-3 mb-4">{{ _("You don't have any categories yet.") }}</p>
                            <a href="{{ url_for('category.add_category') }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>{{ _('Add Your First Category') }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Account Balance Chart -->
            <div class="col-md-6 col-lg-6">
                <div class="card h-100 chart-card">
                    <div class="card-body">
                        <h5 class="chart-title">
                            <i class="bi bi-bar-chart-fill"></i>
                            {{ _('Account Balances') }}
                        </h5>
                        <p class="chart-description">{{ _('Compare balances across all your linked accounts at a glance') }}</p>
                        <div class="chart-container">
                            <canvas id="balanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Income vs Expense Chart -->
            <div class="col-md-6 col-lg-6">
                <div class="card h-100 chart-card">
                    <div class="card-body">
                        <h5 class="chart-title">
                            <i class="bi bi-circle-half"></i>
                            {{ _('Income vs Expense') }}
                        </h5>
                        <p class="chart-description">{{ _('Get insights into your financial balance with this comprehensive overview') }}</p>
                        <div class="chart-container">
                            <canvas id="incomeExpenseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block extra_js %}
<!-- Include Chart.js with plugins -->
<script nonce="{{ csp_nonce() }}" src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script nonce="{{ csp_nonce() }}" src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<!-- Include custom JavaScript files that don't depend on chart data -->
<script nonce="{{ csp_nonce() }}" src="{{ url_for('static', filename='js/forms.js') }}"></script>
<script nonce="{{ csp_nonce() }}" src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- Make chart data available BEFORE any chart init scripts run -->
<div id="chart-data-holder" data-json='{{ chart_data|tojson }}' style="display:none"></div>

<!-- This sets window.chartData by reading the holder above -->
<script nonce="{{ csp_nonce() }}" src="{{ url_for('static', filename='js/dashboard_page_init.js') }}"></script>

<!-- Now load charts.js which will see window.chartData populated -->
<script nonce="{{ csp_nonce() }}" src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script nonce="{{ csp_nonce() }}">
// Button-only filters: manage active state and trigger chart updates
// Depends on updateCharts() from charts.js and .quick-account-btn / .quick-range-btn markup

document.addEventListener('DOMContentLoaded', function() {
  const accountButtons = document.querySelectorAll('.quick-account-btn');
  const rangeButtons = document.querySelectorAll('.quick-range-btn');
  const clearBtn = document.getElementById('clearChartFilters');

  function setActive(group, targetBtn) {
    group.forEach(btn => {
      const isActive = btn === targetBtn;
      btn.classList.toggle('active', isActive);
      btn.classList.toggle('btn-primary', isActive);
      btn.classList.toggle('btn-outline-primary', !isActive);
    });
  }

  function getActiveValue(group, dataKey) {
    const active = Array.from(group).find(b => b.classList.contains('active'));
    return active ? active.dataset[dataKey] : null;
  }

  // Account buttons
  accountButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      if (this.classList.contains('active')) {
        this.classList.add('pulse');
        setTimeout(() => this.classList.remove('pulse'), 300);
        return;
      }
      setActive(accountButtons, this);
      if (typeof updateCharts === 'function') updateCharts();
    });
  });

  // Date range buttons
  rangeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      if (this.classList.contains('active')) {
        this.classList.add('pulse');
        setTimeout(() => this.classList.remove('pulse'), 300);
        return;
      }
      setActive(rangeButtons, this);
      if (typeof updateCharts === 'function') updateCharts();
    });
  });

  // Clear button resets to defaults
  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      const currentAccount = getActiveValue(accountButtons, 'account');
      const currentRange = getActiveValue(rangeButtons, 'range');
      let changed = false;

      if (currentAccount !== 'all') {
        const btnAll = Array.from(accountButtons).find(b => b.dataset.account === 'all');
        if (btnAll) { setActive(accountButtons, btnAll); changed = true; }
      }
      if (currentRange !== 'overall') {
        const btnOverall = Array.from(rangeButtons).find(b => b.dataset.range === 'overall');
        if (btnOverall) { setActive(rangeButtons, btnOverall); changed = true; }
      }

      if (changed) {
        if (typeof updateCharts === 'function') updateCharts();
      } else {
        clearBtn.classList.add('disabled');
        setTimeout(() => clearBtn.classList.remove('disabled'), 300);
      }
    });
  }
});
</script>
{% endblock %}