{% extends "main/base.html" %}
{% block title %}{{ _('Budget Setup') }} - Money Tracker{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">{{ _('Budget Setup') }}</h1>
      <p class="text-muted mb-0">{{ _('Create and manage your category budgets with flexible settings') }}</p>
    </div>
    <a href="{{ url_for('budget.dashboard') }}" class="btn btn-primary">
      <i class="bi bi-bar-chart me-2"></i>{{ _('Budget Dashboard') }}
    </a>
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body p-4">
      <div class="d-flex align-items-center mb-4">
        <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
          <i class="bi bi-plus-circle text-primary fs-4"></i>
        </div>
        <div>
          <h5 class="card-title mb-1 fw-semibold">{{ _('Create New Budget') }}</h5>
          <p class="text-muted mb-0">{{ _('Set up a budget for any category with flexible options') }}</p>
        </div>
      </div>
      
      <form method="post" class="budget-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="row g-4">
          <div class="col-md-6">
            <label class="form-label fw-medium">{{ _('Category') }} <span class="text-danger">*</span></label>
            <select name="category_id" class="form-select form-select-lg" required>
              <option value="">{{ _('Choose a category...') }}</option>
              {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="col-md-6">
            <label class="form-label fw-medium">{{ _('Account Scope') }}</label>
            <select name="account_id" class="form-select form-select-lg">
              <option value="">{{ _('All Accounts') }}</option>
              {% for acc in accounts %}
              <option value="{{ acc.id }}">{{ acc.bank_name }} ({{ acc.account_number|account_number_rtl }})</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="col-md-4">
            <label class="form-label fw-medium">{{ _('Period') }} <span class="text-danger">*</span></label>
            <select name="period" class="form-select form-select-lg" required>
              {% for p in periods %}
              <option value="{{ p }}" {% if p == 'monthly' %}selected{% endif %}>{{ p|capitalize }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="col-md-4">
            <label class="form-label fw-medium">{{ _('Budget Amount') }} <span class="text-danger">*</span></label>
            <div class="input-group input-group-lg">
              <span class="input-group-text bg-light fw-medium">OMR</span>
              <input type="number" name="amount" step="0.001" min="0" class="form-control" placeholder="0.000" required>
            </div>
          </div>
          
          <div class="col-md-4">
            <label class="form-label fw-medium">{{ _('Alert at') }}</label>
            <div class="input-group input-group-lg">
              <input type="number" name="alert_threshold" step="1" min="10" max="100" class="form-control" value="80">
              <span class="input-group-text bg-light fw-medium">%</span>
            </div>
          </div>
          
          <div class="col-12">
            <div class="bg-light rounded p-3">
              <label class="form-label fw-medium mb-3">{{ _('Options') }}</label>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" role="switch" name="rollover_enabled" id="rollover">
                    <label class="form-check-label fw-medium" for="rollover">
                      {{ _('Enable Rollover') }}
                      <small class="d-block text-muted">{{ _('Unused budget carries over to next period') }}</small>
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" role="switch" name="is_active" id="active" checked>
                    <label class="form-check-label fw-medium" for="active">
                      {{ _('Active Budget') }}
                      <small class="d-block text-muted">{{ _('Start tracking immediately') }}</small>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-12">
            <button class="btn btn-primary btn-lg px-5" type="submit">
              <i class="bi bi-check-circle me-2"></i>{{ _('Create Budget') }}
            </button>
            <button type="reset" class="btn btn-outline-secondary btn-lg px-4 ms-2">
              <i class="bi bi-arrow-clockwise me-2"></i>{{ _('Reset') }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% set existing = budgets %}
  {% if existing %}
  <div class="mt-5">
    <div class="d-flex align-items-center mb-4">
      <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
        <i class="bi bi-check-circle-fill text-success"></i>
      </div>
      <div>
        <h5 class="mb-0">{{ _('Active Budgets') }}</h5>
        <small class="text-muted">{{ existing|length }} {{ _('budget') if existing|length == 1 else _('budgets') }} {{ _('configured') }}</small>
      </div>
    </div>
    
    <div class="row g-3">
      {% for key, b in existing.items() %}
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <h6 class="card-title mb-0 fw-semibold">{{ b.category.name if b.category else 'All Categories' }}</h6>
                  <span class="badge {{ 'bg-success' if b.is_active else 'bg-secondary' }} ms-2">
                    {{ _('Active') if b.is_active else _('Inactive') }}
                  </span>
                </div>
                <div class="text-muted small mb-2">
                  <i class="bi bi-clock me-1"></i>{{ b.period|capitalize }}
                </div>
                {% if b.account %}
                <div class="text-muted small">
                  <i class="bi bi-bank me-1"></i>{{ b.account.bank_name }} {{ b.account.account_number|account_number_rtl }}
                </div>
                {% else %}
                <div class="text-muted small">
                  <i class="bi bi-globe me-1"></i>All Accounts
                </div>
                {% endif %}
              </div>
              <div class="dropdown">
                <button class="btn btn-light btn-sm" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <form method="post" action="{{ url_for('budget.toggle', budget_id=b.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="dropdown-item" type="submit">
                        <i class="bi {{ 'bi-pause' if b.is_active else 'bi-play' }} me-2"></i>
                        {{ _('Disable') if b.is_active else _('Enable') }}
                      </button>
                    </form>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form method="post" action="{{ url_for('budget.delete', budget_id=b.id) }}" data-confirm="Delete this budget?">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="dropdown-item text-danger" type="submit">
                        <i class="bi bi-trash me-2"></i>{{ _('Delete') }}
                      </button>
                    </form>
                  </li>
                </ul>
              </div>
            </div>
            
            <div class="d-flex align-items-center justify-content-between bg-light rounded p-3">
              <div class="text-center">
                <div class="fw-semibold text-primary">OMR {{ '%.3f' % (b.amount or 0) }}</div>
                <small class="text-muted">{{ _('Budget') }}</small>
              </div>
              {% if b.rollover and b.rollover > 0 %}
              <div class="text-center">
                <div class="fw-semibold text-success">OMR {{ '%.3f' % b.rollover }}</div>
                <small class="text-muted">{{ _('Rollover') }}</small>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

    </div>
  </div>

  <div class="mt-3">
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
    </a>
  </div>
</div>
{% endblock %}
