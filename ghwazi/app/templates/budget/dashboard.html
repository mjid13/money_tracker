{% extends "main/base.html" %}
{% block title %}{{ _('Budget Dashboard') }} - Money Tracker{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">{{ _('Budget Dashboard') }}</h1>
      <p class="text-muted mb-0">{{ _('Track your spending across all categories and accounts') }}</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('budget.setup') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>{{ _('Setup Budgets') }}
      </a>
      <a href="{{ url_for('budget.status_json') }}" class="btn btn-outline-secondary">
        <i class="bi bi-code-slash me-2"></i>JSON
      </a>
    </div>
  </div>

  {% if budgets %}
  <div class="row g-4">
    {% for b in budgets %}
    <div class="col-lg-6">
      <div class="card h-100 shadow-sm border-0 {% if b.alerts.gte_100 %}border-danger{% elif b.alerts.custom_exceeded %}border-warning{% endif %}">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
              <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                <i class="bi bi-wallet2 text-primary"></i>
              </div>
              <div>
                <h6 class="card-title mb-0 fw-semibold">{{ b.category_name }}</h6>
                <small class="text-muted">{{ b.account_label }}</small>
              </div>
            </div>
            <span class="badge fs-6 {% if b.percent_used >= 100 %}bg-danger{% elif b.percent_used >= b.alerts.threshold %}bg-warning{% else %}bg-success{% endif %}">
              {{ '%.1f' % b.percent_used }}%
            </span>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted fw-medium">{{ _('BUDGET PROGRESS') }}</small>
              <small class="text-muted">{{ b.period|capitalize }} {{ _('Period') }}</small>
            </div>
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar {% if b.percent_used >= 100 %}bg-danger{% elif b.percent_used >= b.alerts.threshold %}bg-warning{% else %}bg-success{% endif %}" 
                   role="progressbar" style="width: {% if b.percent_used > 100 %}100{% else %}{{ b.percent_used }}{% endif %}%"></div>
            </div>
            <div class="d-flex justify-content-between text-muted small">
              <span>{{ b.period_start|date_format('%d %b') }}</span>
              <span>{{ b.period_end|date_format('%d %b %Y') }}</span>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-4">
              <div class="text-center">
                <div class="fw-semibold text-primary">OMR {{ '%.3f' % b.amount }}</div>
                <small class="text-muted">{{ _('Budget') }}</small>
                {% if b.rollover and b.rollover > 0 %}
                <div class="text-success small">+{{ '%.3f' % b.rollover }} {{ _('rollover').lower() }}</div>
                {% endif %}
              </div>
            </div>
            <div class="col-4">
              <div class="text-center">
                <div class="fw-semibold text-danger">OMR {{ '%.3f' % b.spent }}</div>
                <small class="text-muted">{{ _('Spent') }}</small>
              </div>
            </div>
            <div class="col-4">
              <div class="text-center">
                <div class="fw-semibold {% if b.remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                  OMR {{ '%.3f' % b.remaining }}
                </div>
                <small class="text-muted">{{ _('Remaining') }}</small>
              </div>
            </div>
          </div>

          {% if b.alerts.custom_exceeded or b.alerts.gte_100 %}
          <div class="mt-3">
            {% if b.alerts.gte_100 %}
            <div class="alert alert-danger border-0 mb-2">
              <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-octagon me-2"></i>
                <div>
                  <div class="fw-semibold">{{ _('Budget Exceeded') }}</div>
                  <small>{{ _('You\'ve overspent by OMR %(amount)s', amount='%.3f' % (b.spent - (b.amount + (b.rollover or 0)))) }}</small>
                </div>
              </div>
            </div>
            {% elif b.alerts.custom_exceeded %}
            <div class="alert alert-warning border-0 mb-2">
              <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <div>
                  <div class="fw-semibold">{{ _('Approaching Limit') }}</div>
                  <small>{{ '%.0f' % b.alerts.threshold }}{{ _('% of budget used') }}</small>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-5">
    <div class="bg-light rounded-circle mx-auto mb-4" style="width: 120px; height: 120px; display: flex; align-items: center; justify-content: center;">
      <i class="bi bi-wallet2 display-4 text-muted"></i>
    </div>
    <h4 class="text-muted mb-2">{{ _('No budgets configured') }}</h4>
    <p class="text-muted mb-4">{{ _('Start tracking your spending by creating your first budget') }}</p>
    <a href="{{ url_for('budget.setup') }}" class="btn btn-primary btn-lg">
      <i class="bi bi-plus-circle me-2"></i>{{ _('Create Your First Budget') }}
    </a>
  </div>
  {% endif %}

  <div class="mt-3">
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
    </a>
  </div>
</div>
{% endblock %}
