{% extends "main/base.html" %}

{% block title %}Processing Emails - Money Tracker{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="spinner-processing mb-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                        </div>
                        <h2 class="h4 mb-2">Processing Your Emails</h2>
                        <p class="text-body-secondary mb-0" id="statusMessage">Initializing...</p>
                    </div>

                    <div class="progress-container">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="progress-label">Progress</span>
                            <span class="progress-percentage">0%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 0%">
                            </div>
                        </div>
                    </div>

                    <div class="stats-container mt-4" style="display: none;">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="p-3 rounded-3 bg-success-subtle">
                                    <h6 class="text-success mb-1">Processed</h6>
                                    <span class="h4 mb-0 text-success processed-count">0</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 rounded-3 bg-primary-subtle">
                                    <h6 class="text-primary mb-1">Saved</h6>
                                    <span class="h4 mb-0 text-primary saved-count">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="time-info mt-4">
                        <div class="d-flex justify-content-between text-body-secondary small">
                            <span>Elapsed time: <span id="elapsedTime">0s</span></span>
                            <span>Estimated time remaining: <span id="remainingTime">Calculating...</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-2"></i>Return to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce() }}">
    const taskId = "{{ task_id }}";
    let isCompleted = false;

    function formatTime(seconds) {
        if (seconds < 60) {
            return Math.round(seconds) + 's';
        } else if (seconds < 3600) {
            return Math.round(seconds / 60) + 'm ' + Math.round(seconds % 60) + 's';
        } else {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.round((seconds % 3600) / 60);
            return hours + 'h ' + minutes + 'm';
        }
    }

    function updateProgress() {
        if (isCompleted) return;

        fetch(`/api/email_task_status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                const progress = data.progress || 0;
                document.querySelector('.progress-bar').style.width = `${progress}%`;
                document.querySelector('.progress-percentage').textContent = `${progress}%`;

                // Update status message
                const statusMessage = document.getElementById('statusMessage');
                if (data.message) {
                    statusMessage.textContent = data.message;
                } else if (data.status === 'processing') {
                    statusMessage.textContent = 'Processing emails...';
                }

                // Update time information
                document.getElementById('elapsedTime').textContent = formatTime(data.elapsed_seconds);
                if (data.estimated_seconds) {
                    document.getElementById('remainingTime').textContent = formatTime(data.estimated_seconds);
                }

                // Handle completion
                if (data.status === 'completed') {
                    isCompleted = true;
                    document.querySelector('.spinner-processing').style.display = 'none';
                    statusMessage.textContent = 'Processing completed!';

                    // Show stats
                    document.querySelector('.stats-container').style.display = 'block';
                    document.querySelector('.processed-count').textContent = data.parsed_count || 0;
                    document.querySelector('.saved-count').textContent = data.saved_count || 0;

                    // Redirect if there's a result
                    if (data.redirect_url) {
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 1500);
                    }
                } else if (data.status === 'error') {
                    isCompleted = true;
                    document.querySelector('.spinner-processing').style.display = 'none';
                    statusMessage.textContent = data.message || 'An error occurred';
                    document.querySelector('.progress-bar').classList.add('bg-danger');
                } else {
                    // Continue polling
                    setTimeout(updateProgress, 1000);
                }
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
                document.getElementById('statusMessage').textContent = 'Error checking progress';
                document.querySelector('.progress-bar').classList.add('bg-danger');
            });
    }

    // Start progress tracking when page loads
    document.addEventListener('DOMContentLoaded', () => {
        updateProgress();
    });
</script>
{% endblock %}